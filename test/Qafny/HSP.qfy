// Hidden Shift problem
// https://arxiv.org/pdf/quant-ph/0211140.pdf 
method HSP (q : Q[n], p : Q[n], n:nat, f : [Bool] -> [Bool], q:nat, prime:nat, chi: [Bool] -> [Bool]) returns (s:nat, prob:nat)
  requires { q[0 , n) : nor ↦ |0⟩ }
  requires { p[0 , n) : nor ↦ |0⟩ }
  ensures prob == 1 - 1/q
  ensures forall x :: 0 <= x < 2^n ==> f(x) == chi(x+s)
{
  q[0, n) *= H;
  p[0, n) *= H;
  
  for i in [0, n) with q[i]
    separates q[0, i), p[0, n)
    invariant {
      q[0, i), p[0, n) : En ↦ ∑ k ∈ [0, 2^i)) . 1 / sqrt(2^n) . | f(k, p[k]), k ⟩
    }
    invariant {
      q [i , n) : had ↦ |+⟩
    }
  {
    q[0, n) *= λ ((x: Q n, y:Q n) => (((x + f(x))), y));
  }

  q[0,n) *= QFT;

  for i in [0, n) with q[i]
    separates q[0, i), p[0, n)
    invariant {
      q[0, i), p[0, n) : en ↦ ∑ k ∈ [0, 2^i)) . 1 / sqrt(2^n) . | k , f(k, p[k]) ⟩
    }
    invariant {
      q [i , n) : had ↦ |+⟩
    }
  {
    q[0, n) *= λ ((x: Q n, y:Q n) => (x, ((y + f(x)))));
  }

  q[0,n) *= RQFT;

  y,prob *= measure(q);

  s *= NOT(y)
}
