// QFT mod Q
// https://people.eecs.berkeley.edu/~vazirani/s09quantum/notes/lecture6.pdf
// Section 0.3
//the document contains bugs. The controlled-shift is not clear, and the eigenvalue state is not explained properly.
//the following proof might be bad, a better way to do the proof is to first apply the QPE on the eigen value function 
//ω (v * a, 2^n) (|k> -> |k + 2^j mod Q>) actually turns   ω (v * a, 2^n) to be ω (v * a - 2^j * a, 2^n), without the final measurement
//Then, the steps from 39 to 55 are just the inversed QPE. In quantum, if a unitary is given, we can have the axiom,
//where the inversed function f^-1 takes the output of the original function f and it produces the input.
method QFTModQ(n:nat, q : Q[n], p : Q[n], r : Q[1], u : Q[1], N:nat)
  requires { q[0,n), p[0,n) : en(2) ↦ ∑ k ∈ [0, 2^n) . ∑ j ∈ [0, 2^n) . 1/2^n | k ⟩ | j ⟩ }
  requires { r [0] : nor ↦ |0⟩ }
  requires { u [0] : nor ↦ |0⟩ }
  ensures  { q[0,n), p[0,n), u[0, 1), r[0, 1) : en(3) ↦ ∑ k ∈ [0, 2^n) . ∑ j ∈ [0, 2^n)@(j < N) . ∑ i ∈ [0, 2) . 1/2^n * (1/sqrt(2^1))  | k ⟩ | j ⟩ | 1 ⟩ | i ⟩ + ∑ k ∈ [0, 2^n) . ∑ j ∈ [0, 2^n)@ (not (j < N) ) . ∑ i ∈ [0, 2) . 1/2^n | k ⟩ | j ⟩ | 0 ⟩ | 0 ⟩ }
{
  // induce superposition on the first qubit
  if (p[0,n) < N @ u[0]) { r[0] *= H; }
  //(en)q[0,n); //it is best if we do not need this
}
